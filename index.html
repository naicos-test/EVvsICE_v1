<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EV vs ICE — TCO/NPV con Sensibilidades</title>
<link rel="icon" href="logo.svg"/>
<style>
:root{--bg:#0b1220;--card:#141c2c;--ink:#e9eef7;--muted:#9fb0c9;--accent:#5dd0a6;--danger:#ff6b6b}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial;color:var(--ink);background:linear-gradient(120deg,#0b1220,#0f1a31 55%)}
.wrap{max-width:1200px;margin:32px auto;padding:0 16px}
h1{font-size:26px;margin:0 0 6px}
.subtitle{color:var(--muted);margin:0 0 16px}
.grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px}
.card{background:var(--card);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.card h2{margin:0 0 8px;font-size:18px}
.row{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin:8px 0;align-items:center}
.row>div{display:flex;gap:8px;align-items:center}
label{font-size:13px;color:var(--muted)}
input,select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #27324a;background:#0d1422;color:var(--ink)}
.small{font-size:12px;color:var(--muted)}
.full{grid-column:1 / -1}
.btn{background:var(--accent);color:#072a1f;border:none;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
.btn2{background:#2f8fff;color:#07192a;border:none;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
.btn-danger{background:var(--danger);color:#2a0707}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.result{font-size:14px;line-height:1.5}
.winner{font-weight:700;color:var(--accent)}
.muted{color:var(--muted)}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.hdr{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px}
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:8px}
.pill{background:#0d1422;border:1px solid #27324a;border-radius:12px;padding:8px 10px}
.section{margin-top:16px}
.link{color:#8ec6ff;text-decoration:none}
@media(max-width:1100px){.grid{grid-template-columns:1fr}.kpi{grid-template-columns:1fr}}
canvas{background:#0d1422;border:1px solid #27324a;border-radius:12px;padding:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div>
      <h1><img src="logo.svg" alt="logo" style="width:26px;vertical-align:middle;margin-right:6px"/> EV vs ICE — Comparador económico</h1>
      <p class="subtitle">TCO/NPV con tarifas planas o TOU, sensibilidades y gráficos. <a class="link" href="ayuda.html">Ayuda</a></p>
    </div>
    <div class="actions">
      <button class="btn2" id="shareUrl">Compartir escenario</button>
      <button class="btn2" id="exportCsv">Exportar CSV (Excel)</button>
      <button class="btn" id="exportPdf">Exportar PDF</button>
    </div>
  </div>

  <div class="grid">
    <!-- Panel izquierdo: inputs -->
    <div class="card">
      <h2>Supuestos base</h2>
      <div class="row">
        <label>Escenario rápido</label>
        <div>
          <select id="escenario">
            <option value="custom">Personalizado</option>
            <option value="H3r8">H=3 años, r=8%</option>
            <option value="H5r8">H=5 años, r=8%</option>
            <option value="H8r8">H=8 años, r=8%</option>
            <option value="H3r12">H=3 años, r=12%</option>
            <option value="H5r12">H=5 años, r=12%</option>
            <option value="H8r12" selected>H=8 años, r=12%</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div class="pill">
          <label>Kilómetros por año</label>
          <input id="km" type="range" min="8000" max="30000" step="500" value="15000"/>
          <div class="small"><span id="km_v">15.000</span> km/año</div>
        </div>
        <div class="pill">
          <label>Tasa de descuento r (%)</label>
          <input id="r" type="range" min="6" max="16" step="0.5" value="12"/>
          <div class="small"><span id="r_v">12</span>%</div>
        </div>
        <div class="pill">
          <label>Horizonte H (años)</label>
          <input id="H" type="range" min="3" max="10" step="1" value="8"/>
          <div class="small"><span id="H_v">8</span> años</div>
        </div>
        <div class="pill">
          <label>Valor residual EV (% MSRP)</label>
          <input id="res_ev" type="range" min="20" max="55" step="1" value="40"/>
          <div class="small"><span id="res_ev_v">40</span>%</div>
        </div>
        <div class="pill">
          <label>Valor residual ICE (% MSRP)</label>
          <input id="res_ice" type="range" min="25" max="60" step="1" value="35"/>
          <div class="small"><span id="res_ice_v">35</span>%</div>
        </div>
        <div class="pill">
          <label>% carga en hogar EV</label>
          <input id="mix_home" type="range" min="0" max="100" step="1" value="70"/>
          <div class="small"><span id="mix_home_v">70</span>% (resto pública)</div>
        </div>
      </div>

      <div class="section">
        <h2>Energía & mantención</h2>
        <div class="grid2">
          <div class="pill">
            <label>Consumo EV (kWh/100 km)</label>
            <input id="kwh100" type="range" min="11" max="20" step="0.5" value="15"/>
            <div class="small"><span id="kwh100_v">15.0</span> kWh/100 km</div>
          </div>

          <div class="pill">
            <label>Modo tarifa hogar</label>
            <select id="tarifa_mode">
              <option value="flat" selected>Plana</option>
              <option value="tou">TOU (valle+punta)</option>
            </select>
            <div class="small">Aplica solo a carga en hogar</div>
          </div>

          <div class="pill" id="p_home_flat_wrap">
            <label>Precio kWh hogar (plana)</label>
            <input id="p_kwh_home" type="range" min="100" max="300" step="5" value="200"/>
            <div class="small">CLP <span id="p_kwh_home_v">200</span>/kWh</div>
          </div>

          <div class="pill" id="p_home_tou_wrap" style="display:none">
            <label>TOU hogar: valle / punta / % valle</label>
            <div class="small">
              <span>Valle:</span> CLP <span id="p_kwh_valle_v">140</span>,
              <span>Punta:</span> CLP <span id="p_kwh_punta_v">280</span>,
              <span>% valle:</span> <span id="share_valle_v">70</span>%
            </div>
            <input id="p_kwh_valle" type="range" min="80" max="250" step="5" value="140"/>
            <input id="p_kwh_punta" type="range" min="180" max="500" step="5" value="280"/>
            <input id="share_valle" type="range" min="0" max="100" step="1" value="70"/>
          </div>

          <div class="pill">
            <label>Precio kWh pública</label>
            <input id="p_kwh_pub" type="range" min="200" max="500" step="10" value="380"/>
            <div class="small">CLP <span id="p_kwh_pub_v">380</span>/kWh</div>
          </div>

          <div class="pill">
            <label>Consumo ICE (L/100 km)</label>
            <input id="l100" type="range" min="5" max="10" step="0.1" value="7"/>
            <div class="small"><span id="l100_v">7.0</span> L/100 km</div>
          </div>
          <div class="pill">
            <label>Precio combustible (CLP/L)</label>
            <input id="p_fuel" type="range" min="900" max="1600" step="10" value="1200"/>
            <div class="small">CLP <span id="p_fuel_v">1.200</span>/L</div>
          </div>
          <div class="pill">
            <label>Mantención EV (CLP/año)</label>
            <input id="mant_ev" type="range" min="100000" max="350000" step="10000" value="200000"/>
            <div class="small">CLP <span id="mant_ev_v">200.000</span>/año</div>
          </div>
          <div class="pill">
            <label>Mantención ICE (CLP/año)</label>
            <input id="mant_ice" type="range" min="250000" max="600000" step="10000" value="380000"/>
            <div class="small">CLP <span id="mant_ice_v">380.000</span>/año</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Compra</h2>
        <div class="grid2">
          <div class="pill">
            <label>Precio EV (CLP)</label>
            <input id="precio_ev" type="range" min="12000000" max="30000000" step="100000" value="19000000"/>
            <div class="small">CLP <span id="precio_ev_v">19.000.000</span></div>
          </div>
          <div class="pill">
            <label>Incentivo/Bono EV (CLP)</label>
            <input id="inc_ev" type="range" min="0" max="5000000" step="50000" value="0"/>
            <div class="small">CLP <span id="inc_ev_v">0</span></div>
          </div>
          <div class="pill">
            <label>Precio ICE (CLP)</label>
            <input id="precio_ice" type="range" min="9000000" max="25000000" step="100000" value="13000000"/>
            <div class="small">CLP <span id="precio_ice_v">13.000.000</span></div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Riesgos / Eventos</h2>
        <div class="row">
          <label>Provisión cambio batería EV (año 8)</label>
          <div><input type="checkbox" id="chg_batt" checked/><span class="small">Costo = kWh batería × CLP/kWh</span></div>
        </div>
        <div class="grid2">
          <div class="pill">
            <label>Tamaño batería EV (kWh)</label>
            <input id="batt_kwh" type="range" min="28" max="40" step="0.5" value="38"/>
            <div class="small"><span id="batt_kwh_v">38.0</span> kWh</div>
          </div>
          <div class="pill">
            <label>Costo pack (CLP/kWh)</label>
            <input id="batt_cost" type="range" min="60000" max="150000" step="5000" value="100000"/>
            <div class="small">CLP <span id="batt_cost_v">100.000</span>/kWh</div>
          </div>
          <div class="pill">
            <label>ICE: mantención “alta” desde año 6</label>
            <input id="ice_bump" type="range" min="0" max="300000" step="10000" value="150000"/>
            <div class="small">+CLP <span id="ice_bump_v">150.000</span>/año (año ≥ 6)</div>
          </div>
        </div>
      </div>

      <div class="row full" style="margin-top:10px">
        <button class="btn" id="calc">Calcular</button>
        <button class="btn btn-danger" id="reset">Reset</button>
      </div>
      <p class="small" style="margin-top:6px">Nota mezcla de carga: % hogar vs % pública se normaliza automáticamente.</p>
    </div>

    <!-- Panel derecho: resultados y gráficos -->
    <div class="card" id="report">
      <h2>Resultados</h2>
      <div class="kpi">
        <div class="pill"><div class="small muted">Recomendación</div><div id="win" class="winner">—</div></div>
        <div class="pill"><div class="small muted">Diferencia NPV (ganador)</div><div id="diff" class="mono">—</div></div>
        <div class="pill"><div class="small muted">Costo por km (ganador)</div><div id="lco" class="mono">—</div></div>
      </div>
      <div id="out" class="result" style="margin-top:10px">
        <p class="muted">Ajusta supuestos y presiona <b>Calcular</b>.</p>
      </div>

      <div class="section">
        <h2>Gráfico Tornado (sensibilidades)</h2>
        <canvas id="tornado" height="320"></canvas>
      </div>

      <div class="section">
        <h2>Costos acumulados (VP) e intersección</h2>
        <canvas id="lines" height="320"></canvas>
        <p class="small" id="crossnote">Intersección: —</p>
      </div>
    </div>
  </div>

  <div class="card section">
    <h2>Notas rápidas</h2>
    <ul class="small">
      <li>EV mantención base: <b>CLP 200.000/año</b> (ajustable). ICE: <b>CLP 380.000/año</b> (ajustable).</li>
      <li>Costo batería paramétrico (por si quieres estresar escenarios); reemplazos reales son poco frecuentes y a veces en garantía.</li>
    </ul>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
function nfmt(n,d=0){return n.toLocaleString('es-CL',{maximumFractionDigits:d})}
function nfmt2(n){return n.toLocaleString('es-CL',{maximumFractionDigits:2})}
function get(id){return document.getElementById(id)}
const qs = new URLSearchParams(location.search);

const defaults = {
  km:15000,r:12,H:8,res_ev:40,res_ice:35,
  kwh100:15,tarifa_mode:'flat',p_kwh_home:200,p_kwh_valle:140,p_kwh_punta:280,share_valle:70,
  p_kwh_pub:380,l100:7,p_fuel:1200,
  mant_ev:200000,mant_ice:380000,
  precio_ev:19000000,inc_ev:0,precio_ice:13000000,
  chg_batt:true,batt_kwh:38,batt_cost:100000,ice_bump:150000
};

function setVal(id,val){
  const el=get(id);
  if(!el) return;
  if(el.type==='checkbox'){ el.checked = (val===true||val==='true'||val===1||val==='1'); }
  else{ el.value = val; }
}

function syncLabels(){
  get('km_v').textContent=nfmt(+get('km').value);
  get('r_v').textContent=+get('r').value;
  get('H_v').textContent=+get('H').value;
  get('res_ev_v').textContent=+get('res_ev').value;
  get('res_ice_v').textContent=+get('res_ice').value;
  get('mix_home_v').textContent=+get('mix_home').value;

  get('kwh100_v').textContent=(+get('kwh100').value).toFixed(1);
  get('p_kwh_home_v').textContent=nfmt(+get('p_kwh_home').value);
  get('p_kwh_valle_v').textContent=nfmt(+get('p_kwh_valle').value);
  get('p_kwh_punta_v').textContent=nfmt(+get('p_kwh_punta').value);
  get('share_valle_v').textContent=nfmt(+get('share_valle').value);

  get('p_kwh_pub_v').textContent=nfmt(+get('p_kwh_pub').value);
  get('l100_v').textContent=(+get('l100').value).toFixed(1);
  get('p_fuel_v').textContent=nfmt(+get('p_fuel').value);

  get('mant_ev_v').textContent=nfmt(+get('mant_ev').value);
  get('mant_ice_v').textContent=nfmt(+get('mant_ice').value);

  get('precio_ev_v').textContent=nfmt(+get('precio_ev').value);
  get('inc_ev_v').textContent=nfmt(+get('inc_ev').value);
  get('precio_ice_v').textContent=nfmt(+get('precio_ice').value);

  get('batt_kwh_v').textContent=(+get('batt_kwh').value).toFixed(1);
  get('batt_cost_v').textContent=nfmt(+get('batt_cost').value);
  get('ice_bump_v').textContent=nfmt(+get('ice_bump').value);

  // Mostrar/ocultar bloques de tarifa
  const mode=get('tarifa_mode').value;
  get('p_home_flat_wrap').style.display=(mode==='flat')?'block':'none';
  get('p_home_tou_wrap').style.display=(mode==='tou')?'block':'none';
}

['km','r','H','res_ev','res_ice','mix_home','kwh100','p_kwh_home','p_kwh_valle','p_kwh_punta','share_valle','p_kwh_pub','l100','p_fuel','mant_ev','mant_ice','precio_ev','inc_ev','precio_ice','batt_kwh','batt_cost','ice_bump','tarifa_mode'].forEach(id=>{
  const el=get(id); if(!el) return;
  el.addEventListener('input', syncLabels);
});

get('escenario').addEventListener('change', ()=>{
  const v=get('escenario').value;
  const map={H3r8:{H:3,r:8},H5r8:{H:5,r:8},H8r8:{H:8,r:8},H3r12:{H:3,r:12},H5r12:{H:5,r:12},H8r12:{H:8,r:12}};
  if(v!=='custom'){ setVal('H',map[v].H); setVal('r',map[v].r); syncLabels(); }
});

function energiaEV(km,kwh100,mode,p_flat,p_valle,p_punta,share_valle,p_pub,mix_home){
  const kwh_year=(km/100)*kwh100;
  const m=Math.min(Math.max(mix_home/100,0),1); // hogar vs pública
  let p_home= p_flat;
  if(mode==='tou'){
    const sv=Math.min(Math.max(share_valle/100,0),1);
    p_home = sv*p_valle + (1-sv)*p_punta;
  }
  const p_mix = m*p_home + (1-m)*p_pub;
  return kwh_year * p_mix;
}
function energiaICE(km,l100,p_fuel){ return (km/100)*l100*p_fuel; }

function npvOption({H,r,km,precio,incentivo,mant,seguro,patentes,otros,energia_fn,residual_pct,add_costs=[]}){
  const rr=r/100; const capex0=precio-incentivo; const residual=precio*(residual_pct/100);
  let npv=capex0;
  const cumVP=[]; // costos acumulados en valor presente por año
  let acc=capex0;
  for(let t=1;t<=H;t++){
    const energia=energia_fn();
    const extra=add_costs.filter(c=>c.year===t).reduce((a,c)=>a+c.amount,0);
    const opex=energia+mant+seguro+patentes+otros+extra;
    const vp= opex/Math.pow(1+rr,t);
    npv+=vp;
    acc+=vp;
    cumVP.push(acc);
  }
  const vpResidual = residual/Math.pow(1+rr,H);
  npv -= vpResidual;
  cumVP[cumVP.length-1] -= vpResidual;
  const eac = npv * (rr/(1-Math.pow(1+rr,-H)));
  const lco = eac / km;
  return {npv,eac,lco,capex0,residual,cumVP};
}

function packInputs(){
  return {
    H:+get('H').value, r:+get('r').value, km:+get('km').value,
    res_ev:+get('res_ev').value, res_ice:+get('res_ice').value,
    kwh100:+get('kwh100').value, tarifa_mode:get('tarifa_mode').value,
    p_kwh_home:+get('p_kwh_home').value, p_kwh_valle:+get('p_kwh_valle').value, p_kwh_punta:+get('p_kwh_punta').value, share_valle:+get('share_valle').value,
    p_kwh_pub:+get('p_kwh_pub').value, l100:+get('l100').value, p_fuel:+get('p_fuel').value,
    mant_ev:+get('mant_ev').value, mant_ice:+get('mant_ice').value,
    precio_ev:+get('precio_ev').value, inc_ev:+get('inc_ev').value, precio_ice:+get('precio_ice').value,
    chg_batt:get('chg_batt').checked, batt_kwh:+get('batt_kwh').value, batt_cost:+get('batt_cost').value, ice_bump:+get('ice_bump').value,
    mix_home:+get('mix_home').value
  };
}

function energiaFns(inp){
  const eEV=()=>energiaEV(inp.km,inp.kwh100,inp.tarifa_mode,inp.p_kwh_home,inp.p_kwh_valle,inp.p_kwh_punta,inp.share_valle,inp.p_kwh_pub,inp.mix_home);
  const eICE=()=>energiaICE(inp.km,inp.l100,inp.p_fuel);
  return {eEV,eICE};
}

function buildAddCosts(inp){
  const add_ev=[];
  if(inp.chg_batt && inp.H>=8) add_ev.push({year:8,amount: inp.batt_kwh*inp.batt_cost});
  const add_ice=[];
  if(inp.H>=6 && inp.ice_bump>0){ for(let y=6;y<=inp.H;y++) add_ice.push({year:y,amount: inp.ice_bump});}
  return {add_ev,add_ice};
}

let tornadoChart=null, linesChart=null;

function renderTornado(baseInputs, baseDeltaNPV){
  // Parámetros y deltas (impacto sobre ΔNPV = NPV_EV − NPV_ICE)
  const tests = [
    {key:'km', label:'Km/año (±20%)', low: baseInputs.km*0.8, high: baseInputs.km*1.2},
    {key:'p_kwh_home', label:'kWh hogar (±30%)', low: Math.round(baseInputs.p_kwh_home*0.7), high: Math.round(baseInputs.p_kwh_home*1.3), cond: baseInputs.tarifa_mode==='flat'},
    {key:'p_kwh_valle', label:'kWh valle (±30%)', low: Math.round(baseInputs.p_kwh_valle*0.7), high: Math.round(baseInputs.p_kwh_valle*1.3), cond: baseInputs.tarifa_mode==='tou'},
    {key:'p_kwh_punta', label:'kWh punta (±30%)', low: Math.round(baseInputs.p_kwh_punta*0.7), high: Math.round(baseInputs.p_kwh_punta*1.3), cond: baseInputs.tarifa_mode==='tou'},
    {key:'p_kwh_pub', label:'kWh pública (±30%)', low: Math.round(baseInputs.p_kwh_pub*0.7), high: Math.round(baseInputs.p_kwh_pub*1.3)},
    {key:'kwh100', label:'Consumo EV (±20%)', low: baseInputs.kwh100*0.8, high: baseInputs.kwh100*1.2},
    {key:'l100', label:'Consumo ICE (±20%)', low: baseInputs.l100*0.8, high: baseInputs.l100*1.2},
    {key:'p_fuel', label:'Combustible (±30%)', low: Math.round(baseInputs.p_fuel*0.7), high: Math.round(baseInputs.p_fuel*1.3)},
    {key:'mix_home', label:'% carga hogar (±20 pt)', low: Math.max(0, baseInputs.mix_home-20), high: Math.min(100, baseInputs.mix_home+20)},
    {key:'r', label:'Tasa r (±4 pt)', low: Math.max(0, baseInputs.r-4), high: baseInputs.r+4},
    {key:'res_ev', label:'Residual EV (±10%)', low: Math.max(0, baseInputs.res_ev-10), high: baseInputs.res_ev+10},
    {key:'res_ice', label:'Residual ICE (±10%)', low: Math.max(0, baseInputs.res_ice-10), high: baseInputs.res_ice+10},
  ].filter(t=>t.cond===undefined || t.cond);

  const labels=[], lows=[], highs=[];
  for(const t of tests){
    const inpLow = {...baseInputs, [t.key]: t.low};
    const inpHigh = {...baseInputs, [t.key]: t.high};
    const lowDelta = deltaNPV(inpLow);
    const highDelta = deltaNPV(inpHigh);
    const span = Math.max(Math.abs(lowDelta-baseDeltaNPV), Math.abs(highDelta-baseDeltaNPV));
    labels.push(t.label); lows.push(lowDelta); highs.push(highDelta);
  }

  const dataSpans = labels.map((_,i)=> Math.max(Math.abs(lows[i]-baseDeltaNPV), Math.abs(highs[i]-baseDeltaNPV)));
  const order = [...dataSpans].map((v,i)=>[v,i]).sort((a,b)=>b[0]-a[0]).map(x=>x[1]);

  const sortedLabels = order.map(i=>labels[i]);
  const leftVals = order.map(i=> Math.min(lows[i], highs[i]) );
  const rightVals= order.map(i=> Math.max(lows[i], highs[i]) );

  const ctx=get('tornado').getContext('2d');
  if(tornadoChart) tornadoChart.destroy();
  tornadoChart = new Chart(ctx, {
    type:'bar',
    data:{
      labels: sortedLabels,
      datasets:[
        {label:'Mín (ΔNPV)', data:leftVals, borderWidth:1},
        {label:'Máx (ΔNPV)', data:rightVals, borderWidth:1}
      ]
    },
    options:{
      indexAxis:'y',
      responsive:true,
      scales:{
        x:{title:{display:true,text:'ΔNPV = NPV_EV − NPV_ICE (CLP)'}, grid:{display:true}, zeroLineWidth:2},
        y:{grid:{display:false}}
      },
      plugins:{legend:{position:'bottom'}}
    }
  });
}

function deltaNPV(customInputs){
  const inp = customInputs || packInputs();
  const {eEV,eICE}=energiaFns(inp);
  const {add_ev,add_ice}=buildAddCosts(inp);
  const ev=npvOption({H:inp.H,r:inp.r,km:inp.km,precio:inp.precio_ev,incentivo:inp.inc_ev,mant:inp.mant_ev,seguro:600000,patentes:250000,otros:0,energia_fn:eEV,residual_pct:inp.res_ev,add_costs:add_ev});
  const ice=npvOption({H:inp.H,r:inp.r,km:inp.km,precio:inp.precio_ice,incentivo:0,mant:inp.mant_ice,seguro:500000,patentes:300000,otros:0,energia_fn:eICE,residual_pct:inp.res_ice,add_costs:add_ice});
  return ev.npv - ice.npv; // negativo favorece EV
}

function calcAndRender(){
  const inp=packInputs();
  const {eEV,eICE}=energiaFns(inp);
  const {add_ev,add_ice}=buildAddCosts(inp);

  const ev=npvOption({H:inp.H,r:inp.r,km:inp.km,precio:inp.precio_ev,incentivo:inp.inc_ev,mant:inp.mant_ev,seguro:600000,patentes:250000,otros:0,energia_fn:eEV,residual_pct:inp.res_ev,add_costs:add_ev});
  const ice=npvOption({H:inp.H,r:inp.r,km:inp.km,precio:inp.precio_ice,incentivo:0,mant:inp.mant_ice,seguro:500000,patentes:300000,otros:0,energia_fn:eICE,residual_pct:inp.res_ice,add_costs:add_ice});

  const winner = ev.npv < ice.npv ? "EV" : "ICE";
  const diff = Math.abs(ev.npv - ice.npv);
  const lco_winner = ev.npv < ice.npv ? ev.lco : ice.lco;

  get('win').textContent=winner;
  get('diff').textContent=`CLP ${nfmt(diff)}`;
  get('lco').textContent=`CLP ${nfmt2(lco_winner)} por km`;

  get('out').innerHTML = `
    <p><span class="winner">Recomendación:</span> <b>${winner}</b> (menor NPV total).</p>
    <p class="muted">ΔNPV (|EV−ICE|): CLP ${nfmt(diff)}. </p>
    <p class="mono">EV → NPV: CLP ${nfmt(ev.npv)} | EAC: CLP ${nfmt(ev.eac)}/año | Costo/km: CLP ${nfmt2(ev.lco)}</p>
    <p class="mono">ICE → NPV: CLP ${nfmt(ice.npv)} | EAC: CLP ${nfmt(ice.eac)}/año | Costo/km: CLP ${nfmt2(ice.lco)}</p>
    <hr/>
    <p class="small muted">Energía anual estimada — EV: CLP ${nfmt(eEV())} · ICE: CLP ${nfmt(eICE())}</p>
  `;

  // Tornado
  const d0 = ev.npv - ice.npv;
  renderTornado(inp, d0);

  // Líneas de costo acumulado (VP) y cruce
  const years = Array.from({length: inp.H}, (_,i)=> i+1);
  const ctx2=get('lines').getContext('2d');
  if(linesChart) linesChart.destroy();
  linesChart = new Chart(ctx2, {
    type:'line',
    data:{
      labels: years.map(y=>`Año ${y}`),
      datasets:[
        {label:'EV (acum. VP)', data:ev.cumVP, tension:0.1, pointRadius:3},
        {label:'ICE (acum. VP)', data:ice.cumVP, tension:0.1, pointRadius:3}
      ]
    },
    options:{
      responsive:true,
      scales:{ y:{title:{display:true,text:'Costo acumulado (CLP, valor presente)'}}},
      plugins:{legend:{position:'bottom'}}
    }
  });

  // Punto de cruce aproximado
  let cross='—';
  for(let i=0;i<years.length;i++){
    const d = ev.cumVP[i]-ice.cumVP[i];
    if(i===0 && Math.sign(d)===0){ cross='Año 1'; break; }
    if(i>0){
      const prev = ev.cumVP[i-1]-ice.cumVP[i-1];
      if((prev<=0 && d>=0) || (prev>=0 && d<=0)){
        // interpolación lineal simple
        const t = Math.abs(prev)/(Math.abs(prev)+Math.abs(d));
        const yearApprox = (i) + t; // entre i y i+1 (base 1)
        cross = `≈ Año ${yearApprox.toFixed(2)}`;
        break;
      }
    }
  }
  get('crossnote').textContent = `Intersección: ${cross}`;

  // Guarda para exportar CSV
  window.__lastResults = {winner,diff,ev,ice, energiaEV:eEV(), energiaICE:eICE(), inputs: inp};
}

// Share URL con parámetros
get('shareUrl').addEventListener('click', ()=>{
  const inp=packInputs();
  const params=new URLSearchParams();
  Object.entries(inp).forEach(([k,v])=> params.set(k,String(v)));
  const url=`${location.origin}${location.pathname}?${params.toString()}`;
  navigator.clipboard.writeText(url).then(()=> alert('Link copiado al portapapeles.'));
});

// PDF
get('exportPdf').addEventListener('click', ()=> window.print());

// CSV
get('exportCsv').addEventListener('click', ()=>{
  const r=window.__lastResults;
  if(!r){ alert('Primero calcula resultados.'); return; }
  const {winner,diff,ev,ice,energiaEV,energiaICE,inputs}=r;
  const rows=[
    ['Campo','Valor'],
    ['Ganador', winner],
    ['Diferencia NPV (CLP)', diff],
    ['EV NPV (CLP)', ev.npv],
    ['EV EAC (CLP/año)', ev.eac],
    ['EV Costo/km (CLP)', ev.lco],
    ['ICE NPV (CLP)', ice.npv],
    ['ICE EAC (CLP/año)', ice.eac],
    ['ICE Costo/km (CLP)', ice.lco],
    ['EV Energía anual (CLP)', energiaEV],
    ['ICE Energía anual (CLP)', energiaICE],
    ['—','—'],
    ['Supuestos',''],
    ...Object.entries(inputs).map(([k,v])=>[k,v])
  ];
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='ev_vs_ice_tco.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

// Reset
get('reset').addEventListener('click', ()=>{
  // limpia querystring y valores
  history.replaceState({},'', location.pathname);
  Object.entries(defaults).forEach(([k,v])=>{
    if(get(k)){
      if(typeof v==='boolean') get(k).checked=v;
      else get(k).value=v;
    }
  });
  get('escenario').value='H8r12';
  syncLabels();
  get('out').innerHTML='<p class="muted">Reseteado. Ajusta y presiona <b>Calcular</b>.</p>';
  get('win').textContent='—'; get('diff').textContent='—'; get('lco').textContent='—';
  get('crossnote').textContent='Intersección: —';
  window.__lastResults=null;
});

// Carga inicial: desde URL o defaults
(function init(){
  // defaults primero
  Object.entries(defaults).forEach(([k,v])=>{
    if(get(k)){
      if(typeof v==='boolean') get(k).checked=v;
      else get(k).value=v;
    }
  });
  // luego override con querystring
  for(const [k,v] of qs.entries()){
    if(get(k)) setVal(k, (/^\d+(\.\d+)?$/.test(v)? Number(v): v));
  }
  syncLabels();
})();
</script>
</body>
</html>
