<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EV vs ICE — Comparador TCO/NPV</title>
<link rel="icon" href="Logo_v1.svg"/>
<style>
/* ───────────────── THEME (claro, minimal, acento índigo) ───────────────── */
:root{
  --bg:#f6f7fb;           /* fondo claro */
  --ink:#1f2533;          /* texto principal */
  --muted:#6b7280;        /* texto secundario */
  --card:#ffffff;         /* tarjetas */
  --line:#e6e8ef;         /* bordes suaves */
  --accent:#6c7ae0;       /* índigo / violeta suave */
  --accent-2:#0ea5e9;     /* cian para datasets extra */
  --accent-3:#f59e0b;     /* ámbar */
  --accent-4:#a78bfa;     /* lila */
  --danger:#ef4444;       /* rojo */
  --ok:#10b981;           /* verde */
  --shadow: 0 10px 30px rgba(17,23,34,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Arial}
a{color:var(--accent);text-decoration:none}
.wrap{max-width:1200px;margin:0 auto;padding:90px 16px 24px} /* espacio para header sticky */

/* ───────────────── Sticky Header KPIs ───────────────── */
.header{
  position:sticky; top:0; z-index:20; backdrop-filter: blur(6px);
  background:rgba(246,247,251,.9); border-bottom:1px solid var(--line);
}
.header-inner{max-width:1200px;margin:0 auto;padding:10px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between}
.brand{display:flex; align-items:center; gap:10px}
.brand h1{font-size:18px; margin:0}
.kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; width:100%; max-width:780px}
.kpi{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px 12px; box-shadow:var(--shadow)}
.kpi small{display:block; color:var(--muted); font-size:12px}
.kpi b{font-size:16px}
.actions{display:flex; gap:8px; flex-wrap:wrap}
.btn{background:var(--accent); color:white; border:none; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer; box-shadow:var(--shadow)}
.btn.alt{background:#111827; color:#fff}
.btn.ghost{background:#eef1ff; color:#2b318a}

/* ───────────────── Layout ───────────────── */
.grid{display:grid; grid-template-columns:1.15fr .85fr; gap:16px}
.card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); padding:14px}
.card h2{margin:0 0 8px; font-size:18px}
.section{margin-top:16px}
.row{display:grid; grid-template-columns:1.2fr .8fr; gap:12px; align-items:center; margin:8px 0}
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
.pill{border:1px solid var(--line); background:#fff; border-radius:12px; padding:8px 10px}
label{color:var(--muted); font-size:12.5px}
input,select{width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#fff; color:var(--ink)}
.small{color:var(--muted); font-size:12px}
.mono{font-family:ui-monospace, Menlo, Consolas, monospace}
hr{border:none; border-top:1px solid var(--line); margin:12px 0}

/* ───────────────── Vehicle list ───────────────── */
.vehlist{display:flex; flex-wrap:wrap; gap:10px}
.veh{flex:1 1 260px; min-width:260px; background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow); padding:10px}
.veh .top{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px}
.badge{font-size:11px; border-radius:10px; padding:3px 8px; border:1px solid var(--line); color:var(--muted)}
.badge.ev{background:#eef8ff; color:#2563eb}
.badge.ice{background:#fff7ed; color:#c2410c}
.kill{border:none; background:transparent; color:#9ca3af; cursor:pointer}

/* ───────────────── Results area ───────────────── */
.kpi-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
.result{font-size:14px; line-height:1.5}
.winner{color:var(--ok); font-weight:800}

/* ───────────────── Category cards w/ sparklines ───────────────── */
.tabs{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 10px}
.tab{border:1px solid var(--line); border-radius:10px; padding:6px 10px; background:#fff; cursor:pointer}
.tab.active{background:#eef1ff; color:#2b318a; border-color:#cfd6ff}
.catgrid{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
.cat{background:#fff; border:1px solid var(--line); border-radius:14px; padding:8px}
.cat h4{margin:0 0 6px; font-size:13px; color:#374151}
.canvas-wrap{height:80px}

/* ───────────────── Charts ───────────────── */
canvas{background:#fff; border:1px solid var(--line); border-radius:12px; padding:6px}

/* ───────────────── Sliders compactos ───────────────── */
:root{ --range-track-h: 4px; --range-thumb: 12px }
input[type="range"]{-webkit-appearance:none; appearance:none; height:var(--range-thumb); padding:0; background:transparent}
input[type="range"]::-webkit-slider-runnable-track{height:var(--range-track-h); background:#d7dbea; border-radius:999px}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none; width:var(--range-thumb); height:var(--range-thumb); border-radius:50%; background:var(--accent); border:2px solid #fff; margin-top:calc((var(--range-track-h) - var(--range-thumb))/2)}
input[type="range"]::-moz-range-track{height:var(--range-track-h); background:#d7dbea; border-radius:999px}
input[type="range"]::-moz-range-thumb{width:var(--range-thumb); height:var(--range-thumb); border-radius:50%; background:var(--accent); border:2px solid #fff}
.pill{padding:6px 8px}.small{font-size:11.5px}

/* ───────────────── Modals ───────────────── */
.modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50}
.modal.show{display:flex}
.modal .panel{max-width:780px; width:96%; background:#fff; border-radius:16px; box-shadow:var(--shadow); padding:14px}
.modal .panel h3{margin:0 0 8px}
.closex{float:right; cursor:pointer; color:#9ca3af}

/* ───────────────── Tables ───────────────── */
.table{width:100%; border-collapse:collapse; font-size:13px}
.table th,.table td{border:1px solid var(--line); padding:6px 8px; text-align:right}
.table th:first-child,.table td:first-child{text-align:left}
.table tfoot td{font-weight:700}

/* ───────────────── Responsive ───────────────── */
@media (max-width:1100px){
  .grid{grid-template-columns:1fr}
  .kpis{grid-template-columns:1fr 1fr}
  .catgrid{grid-template-columns:1fr 1fr}
}
@media (max-width:680px){
  .kpis{grid-template-columns:1fr}
  .catgrid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- ───────────────── Sticky Header ───────────────── -->
<div class="header">
  <div class="header-inner">
    <div class="brand">
      <img src="Logo_v1.svg" alt="logo" style="width:26px;height:26px">
      <h1>EV vs ICE — Comparador TCO/NPV</h1>
    </div>
    <div class="kpis">
      <div class="kpi"><small>Ganador</small><b id="hdr_winner">—</b></div>
      <div class="kpi"><small>ΔNPV (vs. 2°)</small><b id="hdr_dnpv">—</b></div>
      <div class="kpi"><small>CLP/km (ganador)</small><b id="hdr_lco">—</b></div>
      <div class="kpi"><small>Ahorro anual</small><b id="hdr_sav">—</b></div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="help">Ayuda</button>
      <button class="btn ghost" id="shareUrl">Compartir escenario</button>
      <button class="btn" id="calcHeader">Calcular</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="grid">
    <!-- ───────────────── Panel izquierdo: parámetros + vehículos ───────────────── -->
    <div class="card">
      <h2>Parámetros globales</h2>
      <div class="row">
        <label>Escenario rápido</label>
        <div>
          <select id="escenario">
            <option value="custom">Personalizado</option>
            <option value="H3r8">H=3 años, r=8%</option>
            <option value="H5r8">H=5 años, r=8%</option>
            <option value="H8r8">H=8 años, r=8%</option>
            <option value="H3r12">H=3 años, r=12%</option>
            <option value="H5r12">H=5 años, r=12%</option>
            <option value="H8r12" selected>H=8 años, r=12%</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div class="pill">
          <label>Kilómetros/año</label>
          <input id="km" type="range" min="8000" max="30000" step="500" value="15000"/>
          <div class="small"><span id="km_v">15.000</span> km/año</div>
        </div>
        <div class="pill">
          <label>Tasa de descuento r (%)</label>
          <input id="r" type="range" min="6" max="16" step="0.5" value="12"/>
          <div class="small"><span id="r_v">12</span>%</div>
        </div>
        <div class="pill">
          <label>Horizonte H (años)</label>
          <input id="H" type="range" min="3" max="10" step="1" value="8"/>
          <div class="small"><span id="H_v">8</span> años</div>
        </div>
        <div class="pill">
          <label>% carga en hogar EV</label>
          <input id="mix_home" type="range" min="0" max="100" step="1" value="70"/>
          <div class="small"><span id="mix_home_v">70</span>% (resto pública)</div>
        </div>
      </div>

      <div class="section">
        <h2>Energía & precios</h2>
        <div class="grid2">
          <div class="pill">
            <label>Consumo EV (kWh/100 km)</label>
            <input id="kwh100" type="range" min="11" max="20" step="0.5" value="15"/>
            <div class="small"><span id="kwh100_v">15.0</span> kWh/100 km (para “Personalizado”)</div>
          </div>

          <div class="pill">
            <label>Modo tarifa hogar</label>
            <select id="tarifa_mode">
              <option value="flat" selected>Plana</option>
              <option value="tou">TOU (valle+punta)</option>
            </select>
            <div class="small">Aplica a carga en hogar</div>
          </div>

          <div class="pill" id="p_home_flat_wrap">
            <label>Precio kWh hogar (plana)</label>
            <input id="p_kwh_home" type="range" min="100" max="300" step="5" value="200"/>
            <div class="small">CLP <span id="p_kwh_home_v">200</span>/kWh</div>
          </div>

          <div class="pill" id="p_home_tou_wrap" style="display:none">
            <label>TOU hogar: valle / punta / % valle</label>
            <div class="small">
              Valle: CLP <span id="p_kwh_valle_v">140</span> · Punta: CLP <span id="p_kwh_punta_v">280</span> · % valle: <span id="share_valle_v">70</span>%
            </div>
            <input id="p_kwh_valle" type="range" min="80" max="250" step="5" value="140"/>
            <input id="p_kwh_punta" type="range" min="180" max="500" step="5" value="280"/>
            <input id="share_valle" type="range" min="0" max="100" step="1" value="70"/>
          </div>

          <div class="pill">
            <label>Precio kWh pública</label>
            <input id="p_kwh_pub" type="range" min="200" max="500" step="10" value="380"/>
            <div class="small">CLP <span id="p_kwh_pub_v">380</span>/kWh</div>
          </div>

          <div class="pill">
            <label>Consumo ICE (L/100 km)</label>
            <input id="l100" type="range" min="5" max="10" step="0.1" value="7"/>
            <div class="small"><span id="l100_v">7.0</span> L/100 km (para “Personalizado”)</div>
          </div>
          <div class="pill">
            <label>Precio combustible (CLP/L)</label>
            <input id="p_fuel" type="range" min="900" max="1600" step="10" value="1200"/>
            <div class="small">CLP <span id="p_fuel_v">1.200</span>/L</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Mantenciones & seguros</h2>
        <div class="grid2">
          <div class="pill">
            <label>Mantención EV (CLP/año)</label>
            <input id="mant_ev" type="range" min="100000" max="350000" step="10000" value="200000"/>
            <div class="small">CLP <span id="mant_ev_v">200.000</span>/año</div>
          </div>
          <div class="pill">
            <label>Mantención ICE (CLP/año)</label>
            <input id="mant_ice" type="range" min="250000" max="600000" step="10000" value="380000"/>
            <div class="small">CLP <span id="mant_ice_v">380.000</span>/año</div>
          </div>
          <div class="pill">
            <label>Seguro EV (CLP/año)</label>
            <input id="seg_ev" type="range" min="300000" max="900000" step="10000" value="600000"/>
            <div class="small">CLP <span id="seg_ev_v">600.000</span>/año</div>
          </div>
          <div class="pill">
            <label>Seguro ICE (CLP/año)</label>
            <input id="seg_ice" type="range" min="300000" max="900000" step="10000" value="500000"/>
            <div class="small">CLP <span id="seg_ice_v">500.000</span>/año</div>
          </div>
          <div class="pill">
            <label>Permisos/Patentes EV (CLP/año)</label>
            <input id="pat_ev" type="range" min="100000" max="500000" step="10000" value="250000"/>
            <div class="small">CLP <span id="pat_ev_v">250.000</span>/año</div>
          </div>
          <div class="pill">
            <label>Permisos/Patentes ICE (CLP/año)</label>
            <input id="pat_ice" type="range" min="100000" max="500000" step="10000" value="300000"/>
            <div class="small">CLP <span id="pat_ice_v">300.000</span>/año</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Compra & riesgos</h2>
        <div class="grid2">
          <div class="pill">
            <label>Precio EV (Personalizado)</label>
            <input id="precio_ev" type="range" min="12000000" max="40000000" step="100000" value="19000000"/>
            <div class="small">CLP <span id="precio_ev_v">19.000.000</span></div>
          </div>
          <div class="pill">
            <label>Incentivo/Bono EV (CLP)</label>
            <input id="inc_ev" type="range" min="0" max="5000000" step="50000" value="0"/>
            <div class="small">CLP <span id="inc_ev_v">0</span></div>
          </div>
          <div class="pill">
            <label>Precio ICE (Personalizado)</label>
            <input id="precio_ice" type="range" min="9000000" max="30000000" step="100000" value="13000000"/>
            <div class="small">CLP <span id="precio_ice_v">13.000.000</span></div>
          </div>
          <div class="pill">
            <label>Valor residual EV (% MSRP)</label>
            <input id="res_ev" type="range" min="20" max="60" step="1" value="40"/>
            <div class="small"><span id="res_ev_v">40</span>%</div>
          </div>
          <div class="pill">
            <label>Valor residual ICE (% MSRP)</label>
            <input id="res_ice" type="range" min="25" max="60" step="1" value="35"/>
            <div class="small"><span id="res_ice_v">35</span>%</div>
          </div>
        </div>

        <div class="grid2">
          <div class="pill">
            <label>Provisión cambio batería EV (año 8)</label>
            <div class="small"><input type="checkbox" id="chg_batt" checked/> Incluir · Costo = kWh × CLP/kWh</div>
            <div class="small">Tamaño batería (kWh): <span id="batt_kwh_v">38</span> · Costo (CLP/kWh): <span id="batt_cost_v">100.000</span></div>
            <input id="batt_kwh" type="range" min="28" max="70" step="0.5" value="38"/>
            <input id="batt_cost" type="range" min="60000" max="200000" step="5000" value="100000"/>
          </div>
          <div class="pill">
            <label>ICE: mantención “alta” desde año 6</label>
            <input id="ice_bump" type="range" min="0" max="300000" step="10000" value="150000"/>
            <div class="small">+CLP <span id="ice_bump_v">150.000</span>/año (año ≥ 6)</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Vehículos a comparar (hasta 4)</h2>
        <div class="vehlist" id="vehList"></div>
        <div class="actions" style="margin-top:8px">
          <button class="btn" id="addEV">+ Añadir EV</button>
          <button class="btn alt" id="addICE">+ Añadir ICE</button>
        </div>
        <p class="small">Los modelos <b>Personalizado</b> usan tus controles globales. Los demás cargan parámetros sugeridos; puedes ajustar tarifas, mantenciones y riesgos globales.</p>
      </div>
    </div>

    <!-- ───────────────── Panel derecho: resultados y gráficos ───────────────── -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Resultados</h2>
        <small><a href="#" id="openHow">¿Cómo calculamos?</a></small>
      </div>

      <div id="normCosts" class="section"></div>

      <div class="section">
        <h2>Costos acumulados (valor presente)</h2>
        <canvas id="lines" height="320"></canvas>
        <p class="small" id="crossnote">Intersección: —</p>
      </div>

      <div class="section">
        <div class="tabs" id="vehTabs"></div>
        <div class="catgrid">
          <div class="cat"><h4>Energía</h4><div class="canvas-wrap"><canvas id="cat_energy"></canvas></div></div>
          <div class="cat"><h4>Mantención</h4><div class="canvas-wrap"><canvas id="cat_mant"></canvas></div></div>
          <div class="cat"><h4>Seguros/Permisos</h4><div class="canvas-wrap"><canvas id="cat_segs"></canvas></div></div>
          <div class="cat"><h4>Depreciación/Residual</h4><div class="canvas-wrap"><canvas id="cat_depr"></canvas></div></div>
        </div>
      </div>

      <div class="section">
        <h2>Tornado (sensibilidades sobre ΔNPV)</h2>
        <canvas id="tornado" height="320"></canvas>
      </div>
    </div>
  </div>

  <div class="card section">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Detalle por año</h2>
      <label class="small"><input type="checkbox" id="toggleNominal"/> Mostrar en <b>Nominal</b> (desmarcado = Valor Presente)</label>
    </div>
    <div id="tables"></div>
  </div>
</div>

<!-- Modales -->
<div class="modal" id="modalHow">
  <div class="panel">
    <span class="closex" data-x="modalHow">✕</span>
    <h3>¿Cómo calculamos?</h3>
    <p>Usamos NPV del costo total en un horizonte <b>H</b> con tasa de descuento <b>r</b>. OPEX del año <i>t</i> (energía + mantención + seguros + permisos + eventos) se descuenta con <i>(1+r)<sup>t</sup></i>. El NPV resta el VP del residual al final del horizonte.</p>
    <ul class="small">
      <li><b>Energía EV:</b> consumo (kWh/100 km) × km/año × mezcla hogar–pública. Hogar: plana o TOU (valle/punta).</li>
      <li><b>Energía ICE:</b> consumo (L/100 km) × km/año × precio de combustible.</li>
      <li><b>Eventos:</b> provisión de batería EV en año 8 si activa; “bump” ICE desde año 6.</li>
      <li><b>Indicadores:</b> EAC (costo anual equivalente), CLP/km = EAC / km.</li>
    </ul>
  </div>
</div>

<div class="modal" id="modalHelp">
  <div class="panel">
    <span class="closex" data-x="modalHelp">✕</span>
    <h3>Ayuda (contexto Chile)</h3>
    <ul class="small">
      <li><b>Tarifa hogar (plana):</b> ~CLP 110–220/kWh (según plan y comuna).</li>
      <li><b>Hogar TOU:</b> valle ~CLP 90–160/kWh; punta ~CLP 220–380/kWh.</li>
      <li><b>Pública:</b> rápida ~CLP 300–500/kWh; normal ~CLP 200–350/kWh.</li>
      <li><b>Instalación domiciliaria:</b> aprox. CLP 300.000–1.000.000 (wallbox + instalación; varía por empalme y distancia).</li>
    </ul>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* ───────────── Utilidades ───────────── */
const fmtN = (n,d=0)=> n.toLocaleString('es-CL',{maximumFractionDigits:d});
const fmt2 = (n)=> n.toLocaleString('es-CL',{maximumFractionDigits:2});
const $ = (id)=> document.getElementById(id);
const qs = new URLSearchParams(location.search);
function getCSS(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}

/* Estado global (¡sin redeclaraciones!) */
const defaults = {
  km:15000, r:12, H:8, mix_home:70,
  kwh100:15, tarifa_mode:'flat', p_kwh_home:200, p_kwh_valle:140, p_kwh_punta:280, share_valle:70,
  p_kwh_pub:380, l100:7, p_fuel:1200,
  mant_ev:200000, mant_ice:380000, seg_ev:600000, seg_ice:500000, pat_ev:250000, pat_ice:300000,
  precio_ev:19000000, inc_ev:0, precio_ice:13000000, res_ev:40, res_ice:35,
  chg_batt:true, batt_kwh:38, batt_cost:100000, ice_bump:150000
};
const state = { vehicles: [] };     // {id,type:'EV'|'ICE', modelKey}
let tornadoChart=null, linesChart=null, catCharts={}, tabsActive=null;
let lastResults=[];

/* Modelos */
const evModels = [
  {key:'custom', name:'Personalizado', custom:true},
  {key:'byd_dolphin_mini', name:'BYD Dolphin Mini', price:19000000, kwh100:15, batt_kwh:38, residual:40},
  {key:'mg4_std', name:'MG4 Standard', price:23990000, kwh100:16, batt_kwh:51, residual:42},
  {key:'nissan_leaf40', name:'Nissan Leaf 40kWh', price:32000000, kwh100:18, batt_kwh:40, residual:38},
  {key:'tesla_m3_rwd', name:'Tesla Model 3 RWD', price:36900000, kwh100:14, batt_kwh:57, residual:50},
  {key:'byd_yuan_plus', name:'BYD Yuan Plus (Atto 3)', price:28990000, kwh100:16, batt_kwh:60, residual:45},
  {key:'mg_zs_ev', name:'MG ZS EV', price:27990000, kwh100:18, batt_kwh:51, residual:40},
  {key:'jac_e10x', name:'JAC E10X', price:15000000, kwh100:13, batt_kwh:31, residual:35}
];
const iceModels = [
  {key:'custom', name:'Personalizado', custom:true},
  {key:'suzuki_swift', name:'Suzuki Swift 1.2', price:13000000, l100:7.0, residual:35},
  {key:'toyota_yaris', name:'Toyota Yaris 1.5', price:15000000, l100:6.5, residual:40},
  {key:'chevy_onix', name:'Chevrolet Onix 1.0T', price:14500000, l100:6.7, residual:38},
  {key:'kia_rio', name:'Kia Rio 1.4', price:14000000, l100:7.2, residual:36},
  {key:'hyundai_accent', name:'Hyundai Accent 1.4', price:13800000, l100:7.0, residual:36},
  {key:'peugeot_208', name:'Peugeot 208 1.6', price:15500000, l100:7.5, residual:37}
];
function modelList(type){return type==='EV'?evModels:iceModels;}
function findModel(type,key){return modelList(type).find(m=>m.key===key)||modelList(type)[0];}

/* Sync labels */
['km','r','H','mix_home','kwh100','p_kwh_home','p_kwh_valle','p_kwh_punta','share_valle','p_kwh_pub','l100','p_fuel',
 'mant_ev','mant_ice','seg_ev','seg_ice','pat_ev','pat_ice',
 'precio_ev','inc_ev','precio_ice','res_ev','res_ice','batt_kwh','batt_cost','ice_bump','tarifa_mode'
].forEach(id=>{ const el=$(id); if(el){ el.addEventListener('input', syncLabels); }});
$('escenario').addEventListener('change', ()=>{
  const v=$('escenario').value, map={H3r8:{H:3,r:8},H5r8:{H:5,r:8},H8r8:{H:8,r:8},H3r12:{H:3,r:12},H5r12:{H:5,r:12},H8r12:{H:8,r:12}};
  if(v!=='custom'){ $('H').value=map[v].H; $('r').value=map[v].r; syncLabels(); }
});
function syncLabels(){
  if($('km_v')) $('km_v').textContent=fmtN(+$('km').value);
  if($('r_v')) $('r_v').textContent=+$('r').value;
  if($('H_v')) $('H_v').textContent=+$('H').value;
  if($('mix_home_v')) $('mix_home_v').textContent=+$('mix_home').value;

  if($('kwh100_v')) $('kwh100_v').textContent=(+$('kwh100').value).toFixed(1);
  if($('p_kwh_home_v')) $('p_kwh_home_v').textContent=fmtN(+$('p_kwh_home').value);
  if($('p_kwh_valle_v')) $('p_kwh_valle_v').textContent=fmtN(+$('p_kwh_valle').value);
  if($('p_kwh_punta_v')) $('p_kwh_punta_v').textContent=fmtN(+$('p_kwh_punta').value);
  if($('share_valle_v')) $('share_valle_v').textContent=fmtN(+$('share_valle').value);
  if($('p_kwh_pub_v')) $('p_kwh_pub_v').textContent=fmtN(+$('p_kwh_pub').value);

  if($('l100_v')) $('l100_v').textContent=(+$('l100').value).toFixed(1);
  if($('p_fuel_v')) $('p_fuel_v').textContent=fmtN(+$('p_fuel').value);

  if($('mant_ev_v')) $('mant_ev_v').textContent=fmtN(+$('mant_ev').value);
  if($('mant_ice_v')) $('mant_ice_v').textContent=fmtN(+$('mant_ice').value);
  if($('seg_ev_v')) $('seg_ev_v').textContent=fmtN(+$('seg_ev').value);
  if($('seg_ice_v')) $('seg_ice_v').textContent=fmtN(+$('seg_ice').value);
  if($('pat_ev_v')) $('pat_ev_v').textContent=fmtN(+$('pat_ev').value);
  if($('pat_ice_v')) $('pat_ice_v').textContent=fmtN(+$('pat_ice').value);

  if($('precio_ev_v')) $('precio_ev_v').textContent=fmtN(+$('precio_ev').value);
  if($('inc_ev_v')) $('inc_ev_v').textContent=fmtN(+$('inc_ev').value);
  if($('precio_ice_v')) $('precio_ice_v').textContent=fmtN(+$('precio_ice').value);
  if($('res_ev_v')) $('res_ev_v').textContent=fmtN(+$('res_ev').value);
  if($('res_ice_v')) $('res_ice_v').textContent=fmtN(+$('res_ice').value);

  if($('batt_kwh_v')) $('batt_kwh_v').textContent=(+$('batt_kwh').value).toFixed(1);
  if($('batt_cost_v')) $('batt_cost_v').textContent=fmtN(+$('batt_cost').value);
  if($('ice_bump_v')) $('ice_bump_v').textContent=fmtN(+$('ice_bump').value);

  const mode=$('tarifa_mode').value;
  $('p_home_flat_wrap').style.display=(mode==='flat')?'block':'none';
  $('p_home_tou_wrap').style.display=(mode==='tou')?'block':'none';
}

/* Energía anual */
function energiaEV(km,kwh100,mode,p_flat,p_valle,p_punta,share_valle,p_pub,mix_home){
  const kwh_year=(km/100)*kwh100;
  const m=Math.min(Math.max(mix_home/100,0),1);
  let p_home=p_flat;
  if(mode==='tou'){ const sv=Math.min(Math.max(share_valle/100,0),1); p_home=sv*p_valle+(1-sv)*p_punta; }
  const p_mix = m*p_home + (1-m)*p_pub;
  return kwh_year * p_mix;
}
function energiaICE(km,l100,p_fuel){ return (km/100)*l100*p_fuel; }

/* Inputs */
function makeInputs(){
  return {
    H:+$('H').value, r:+$('r').value, km:+$('km').value, mix_home:+$('mix_home').value,
    kwh100:+$('kwh100').value, tarifa_mode:$('tarifa_mode').value,
    p_kwh_home:+$('p_kwh_home').value, p_kwh_valle:+$('p_kwh_valle').value, p_kwh_punta:+$('p_kwh_punta').value, share_valle:+$('share_valle').value,
    p_kwh_pub:+$('p_kwh_pub').value, l100:+$('l100').value, p_fuel:+$('p_fuel').value,
    mant_ev:+$('mant_ev').value, mant_ice:+$('mant_ice').value, seg_ev:+$('seg_ev').value, seg_ice:+$('seg_ice').value, pat_ev:+$('pat_ev').value, pat_ice:+$('pat_ice').value,
    precio_ev:+$('precio_ev').value, inc_ev:+$('inc_ev').value, precio_ice:+$('precio_ice').value, res_ev:+$('res_ev').value, res_ice:+$('res_ice').value,
    chg_batt:$('chg_batt').checked, batt_kwh:+$('batt_kwh').value, batt_cost:+$('batt_cost').value, ice_bump:+$('ice_bump').value
  };
}

/* NPV por opción con VP y Nominal */
function npvOption({H,r,km,precio,incentivo,mant,seguro,patentes,energia_fn,residual_pct,add_costs=[], type}){
  const rr=r/100; const capex0=precio-incentivo; const residual=precio*(residual_pct/100);
  let npv=capex0; let cumVP=[], acc=capex0;
  let byCatVP = {energy:[], mant:[], segs:[], depr:[], events:[]};
  let byCatNom= {energy:[], mant:[], segs:[], depr:[], events:[]};

  for(let t=1;t<=H;t++){
    const energy_nom = energia_fn();
    const event_nom  = add_costs.filter(c=>c.year===t).reduce((a,c)=>a+c.amount,0);
    const opex_nom = energy_nom + mant + seguro + patentes + event_nom;
    const disc = Math.pow(1+rr,t);
    const vp = opex_nom / disc;

    npv+=vp; acc+=vp; cumVP.push(acc);

    byCatNom.energy.push(energy_nom);
    byCatNom.mant.push(mant);
    byCatNom.segs.push(seguro+patentes);
    byCatNom.events.push(event_nom);
    byCatNom.depr.push(0);

    byCatVP.energy.push(energy_nom/disc);
    byCatVP.mant.push(mant/disc);
    byCatVP.segs.push((seguro+patentes)/disc);
    byCatVP.events.push(event_nom/disc);
    byCatVP.depr.push(0);
  }
  const vpResidual = residual/Math.pow(1+rr,H);
  npv -= vpResidual;
  cumVP[cumVP.length-1] -= vpResidual;

  byCatVP.depr[H-1] = -vpResidual;
  byCatNom.depr[H-1] = -residual;

  const eac = npv * (rr/(1-Math.pow(1+rr,-H)));
  const lco = eac / km;
  return {npv,eac,lco,capex0,residual,cumVP,byCatVP,byCatNom};
}

/* Eventos por tipo */
function buildAddCosts(inp,type){
  const arr=[];
  if(type==='EV' && inp.chg_batt && inp.H>=8) arr.push({year:8,amount: inp.batt_kwh*inp.batt_cost});
  if(type==='ICE' && inp.H>=6 && inp.ice_bump>0) for(let y=6;y<=inp.H;y++) arr.push({year:y,amount: inp.ice_bump});
  return arr;
}

/* Vehículos UI */
function addVehicle(type, modelKey){
  if(state.vehicles.length>=4){ alert('Máximo 4 vehículos.'); return; }
  const id = 'v'+Math.random().toString(36).slice(2,8);
  state.vehicles.push({id, type, modelKey: modelKey || 'custom'});
  renderVehList();
}
function removeVehicle(id){
  state.vehicles = state.vehicles.filter(v=>v.id!==id);
  renderVehList();
}
function renderVehList(){
  const box=$('vehList'); box.innerHTML='';
  state.vehicles.forEach((v,idx)=>{
    const m = findModel(v.type,v.modelKey);
    const el=document.createElement('div'); el.className='veh';
    el.innerHTML=`
      <div class="top">
        <span class="badge ${v.type==='EV'?'ev':'ice'}">${v.type}</span>
        <button class="kill" title="Quitar" data-kill="${v.id}">✕</button>
      </div>
      <div class="small" style="margin-bottom:6px">#${idx+1}</div>
      <div class="pill" style="margin-bottom:6px">
        <label>Tipo</label>
        <select data-type="${v.id}">
          <option ${v.type==='EV'?'selected':''}>EV</option>
          <option ${v.type==='ICE'?'selected':''}>ICE</option>
        </select>
      </div>
      <div class="pill">
        <label>Modelo</label>
        <select data-model="${v.id}">
          ${modelList(v.type).map(mm=>`<option value="${mm.key}" ${mm.key===v.modelKey?'selected':''}>${mm.name}</option>`).join('')}
        </select>
        <div class="small mono" style="margin-top:4px">${m.custom?'Usa controles Personalizado.':`Precio: CLP ${fmtN(m.price)} · ${v.type==='EV'?`Consumo: ${m.kwh100} kWh/100km`:`Consumo: ${m.l100} L/100km`}`}</div>
      </div>
    `;
    box.appendChild(el);
  });
  box.querySelectorAll('[data-kill]').forEach(b=> b.onclick=()=> removeVehicle(b.getAttribute('data-kill')));
  box.querySelectorAll('[data-type]').forEach(s=> s.onchange=(e)=>{
    const id=e.target.getAttribute('data-type'); const v=state.vehicles.find(x=>x.id===id);
    v.type = e.target.value; v.modelKey='custom'; renderVehList();
  });
  box.querySelectorAll('[data-model]').forEach(s=> s.onchange=(e)=>{
    const id=e.target.getAttribute('data-model'); const v=state.vehicles.find(x=>x.id===id);
    v.modelKey = e.target.value;
  });
}

/* Cálculo principal */
function calc(){
  const inp = makeInputs();
  const results=[];
  state.vehicles.forEach((v)=>{
    const mod = findModel(v.type, v.modelKey);
    let precio,residual_pct,energia_fn,mant,seguro,patentes;
    if(v.type==='EV'){
      precio = mod.custom? inp.precio_ev : mod.price;
      residual_pct = mod.custom? inp.res_ev : (mod.residual ?? inp.res_ev);
      const kwh100 = mod.custom? inp.kwh100 : (mod.kwh100 ?? inp.kwh100);
      if(mod.batt_kwh && !mod.custom) inp.batt_kwh = mod.batt_kwh; // actualizar evento batería
      energia_fn = ()=> energiaEV(inp.km,kwh100,inp.tarifa_mode,inp.p_kwh_home,inp.p_kwh_valle,inp.p_kwh_punta,inp.share_valle,inp.p_kwh_pub,inp.mix_home);
      mant=inp.mant_ev; seguro=inp.seg_ev; patentes=inp.pat_ev;
      results.push({id:v.id, label:`EV — ${mod.name}`, type:'EV',
        out: npvOption({H:inp.H,r:inp.r,km:inp.km,precio,incentivo:inp.inc_ev,mant,seguro,patentes,energia_fn,residual_pct,add_costs:buildAddCosts(inp,'EV')})});
    }else{
      precio = mod.custom? inp.precio_ice : mod.price;
      residual_pct = mod.custom? inp.res_ice : (mod.residual ?? inp.res_ice);
      const l100 = mod.custom? inp.l100 : (mod.l100 ?? inp.l100);
      energia_fn = ()=> energiaICE(inp.km,l100,inp.p_fuel);
      mant=inp.mant_ice; seguro=inp.seg_ice; patentes=inp.pat_ice;
      results.push({id:v.id, label:`ICE — ${mod.name}`, type:'ICE',
        out: npvOption({H:inp.H,r:inp.r,km:inp.km,precio,incentivo:0,mant,seguro,patentes,energia_fn,residual_pct,add_costs:buildAddCosts(inp,'ICE')})});
    }
  });

  if(results.length===0){ alert('Agrega al menos un EV y un ICE.'); return; }

  // cache resultados para el toggle VP/Nominal
  lastResults = results.slice().sort((a,b)=> a.out.npv - b.out.npv);

  const win = lastResults[0];
  const second = lastResults[1] || null;

  // Header KPIs
  $('hdr_winner').textContent = win.label;
  $('hdr_dnpv').textContent = second ? `CLP ${fmtN(second.out.npv - win.out.npv)}` : '—';
  $('hdr_lco').textContent   = `CLP ${fmt2(win.out.lco)} / km`;
  $('hdr_sav').textContent   = second ? `CLP ${fmtN(second.out.eac - win.out.eac)}/año` : '—';

  // Costo normalizado por vehículo
  const rows = lastResults.map(r=>({label:r.label, lco:r.out.lco, npv:r.out.npv, eac:r.out.eac}));
  const bestLCO = win.out.lco;
  $('normCosts').innerHTML = `
    <div class="kpi-grid">
      ${rows.map((r,i)=>{
        const diffPct = (r.lco - bestLCO)/bestLCO*100;
        return `<div class="kpi">
          <small>${r.label}</small>
          <div style="display:flex;justify-content:space-between"><b>CLP ${fmt2(r.lco)}/km</b><span class="small ${i===0?'winner':''}">${i===0? 'Ganador' : (diffPct>=0? '+' : '')+fmt2(diffPct)+'%'}</span></div>
          <div class="small">NPV: CLP ${fmtN(r.npv)} · EAC: CLP ${fmtN(r.eac)}/año</div>
        </div>`;
      }).join('')}
    </div>
  `;

  // Líneas acumuladas VP
  const years = Array.from({length: makeInputs().H }, (_,i)=> i+1);
  if(linesChart) linesChart.destroy();
  linesChart = new Chart($('lines').getContext('2d'), {
    type:'line',
    data:{ labels: years.map(y=>'Año '+y),
      datasets: lastResults.map((r)=>({label:r.label, data:r.out.cumVP, tension:.1, pointRadius:2, borderWidth:2}))
    },
    options:{ responsive:true, scales:{ y:{title:{display:true,text:'Costo acumulado (CLP, VP)'}}}, plugins:{legend:{position:'bottom'}} }
  });
  // Intersección aprox (ganador vs resto)
  let earliest = null;
  for(let k=1;k<lastResults.length;k++){
    const a = win.out.cumVP, b = lastResults[k].out.cumVP;
    for(let i=1;i<years.length;i++){
      const prev = a[i-1]-b[i-1], cur = a[i]-b[i];
      if((prev<=0&&cur>=0)||(prev>=0&&cur<=0)){
        const t = Math.abs(prev)/(Math.abs(prev)+Math.abs(cur));
        const y = i + t;
        if(!earliest || y < earliest) earliest = y;
        break;
      }
    }
  }
  $('crossnote').textContent = 'Intersección: ' + (earliest ? `≈ Año ${earliest.toFixed(2)}` : '—');

  // Tabs + sparklines
  renderTabs(lastResults);
  renderCategorySparklines(lastResults, (tabsActive || lastResults[0].id));

  // Tornado simple (1° vs 2°)
  const baseDelta = lastResults[1]? (lastResults[0].out.npv - lastResults[1].out.npv) : 0;
  renderTornado(makeInputs(), baseDelta);

  // Tablas
  renderTables(lastResults);
}

/* Tabs + Sparklines */
function renderTabs(results){
  const bar=$('vehTabs'); bar.innerHTML='';
  results.forEach((r,i)=>{
    const b=document.createElement('button');
    b.className='tab'+( (tabsActive?tabsActive===r.id : i===0)?' active':'' );
    b.textContent=r.label;
    b.onclick=()=>{ tabsActive=r.id; renderTabs(results); renderCategorySparklines(results, r.id); };
    bar.appendChild(b);
  });
  if(!tabsActive && results[0]) tabsActive = results[0].id;
}
function renderCategorySparklines(results, id){
  const r = results.find(x=>x.id===id) || results[0];
  const H = makeInputs().H;
  const years = Array.from({length:H}, (_,i)=> ''+(i+1));
  const cats = r.out.byCatVP; // VP en sparklines
  const cfg=(ctx,data)=> new Chart(ctx,{type:'line',data:{labels:years,datasets:[{data, tension:.3, pointRadius:0, borderWidth:2}]},options:{plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}}}});
  ['energy','mant','segs','depr'].forEach(k=>{ if(catCharts[k]) catCharts[k].destroy(); });
  catCharts.energy = cfg($('cat_energy').getContext('2d'), cats.energy);
  catCharts.mant   = cfg($('cat_mant').getContext('2d'),   cats.mant);
  catCharts.segs   = cfg($('cat_segs').getContext('2d'),   cats.segs);
  catCharts.depr   = cfg($('cat_depr').getContext('2d'),   cats.depr);
}

/* Tornado (sobre ΔNPV de 1° vs 2°) */
function renderTornado(inp, baseDelta){
  const dNPV = (tw)=> {
    const pair = simulatePair(inp, tw);
    return pair.main.npv - pair.alt.npv;
  };
  const tests = [
    {k:'km', lb:'Km/año (±20%)', l: inp.km*0.8, h: inp.km*1.2},
    {k:'p_kwh_home', lb:'kWh hogar (±30%)', l: Math.round(inp.p_kwh_home*0.7), h: Math.round(inp.p_kwh_home*1.3), cond: inp.tarifa_mode==='flat'},
    {k:'p_kwh_valle', lb:'kWh valle (±30%)', l: Math.round(inp.p_kwh_valle*0.7), h: Math.round(inp.p_kwh_valle*1.3), cond: inp.tarifa_mode==='tou'},
    {k:'p_kwh_punta', lb:'kWh punta (±30%)', l: Math.round(inp.p_kwh_punta*0.7), h: Math.round(inp.p_kwh_punta*1.3), cond: inp.tarifa_mode==='tou'},
    {k:'p_kwh_pub', lb:'kWh pública (±30%)', l: Math.round(inp.p_kwh_pub*0.7), h: Math.round(inp.p_kwh_pub*1.3)},
    {k:'kwh100', lb:'Consumo EV (±20%)', l: inp.kwh100*0.8, h: inp.kwh100*1.2},
    {k:'l100', lb:'Consumo ICE (±20%)', l: inp.l100*0.8, h: inp.l100*1.2},
    {k:'p_fuel', lb:'Combustible (±30%)', l: Math.round(inp.p_fuel*0.7), h: Math.round(inp.p_fuel*1.3)},
    {k:'mix_home', lb:'% carga hogar (±20 pt)', l: Math.max(0, inp.mix_home-20), h: Math.min(100, inp.mix_home+20)},
    {k:'r', lb:'Tasa r (±4 pt)', l: Math.max(0, inp.r-4), h: inp.r+4},
    {k:'res_ev', lb:'Residual EV (±10 pt)', l: Math.max(0, inp.res_ev-10), h: inp.res_ev+10},
    {k:'res_ice', lb:'Residual ICE (±10 pt)', l: Math.max(0, inp.res_ice-10), h: inp.res_ice+10},
  ].filter(t=>t.cond===undefined || t.cond);
  const labels=[], lows=[], highs=[];
  tests.forEach(t=>{
    const dL = dNPV({[t.k]: t.l});
    const dH = dNPV({[t.k]: t.h});
    labels.push(t.lb); lows.push(dL); highs.push(dH);
  });
  const spans = labels.map((_,i)=> Math.max(Math.abs(lows[i]-baseDelta), Math.abs(highs[i]-baseDelta)));
  const order = spans.map((v,i)=>[v,i]).sort((a,b)=>b[0]-a[0]).map(x=>x[1]);
  const L = order.map(i=>labels[i]), lo=order.map(i=>Math.min(lows[i],highs[i])), hi=order.map(i=>Math.max(lows[i],highs[i]));
  if(tornadoChart) tornadoChart.destroy();
  tornadoChart = new Chart($('tornado').getContext('2d'),{
    type:'bar',
    data:{labels:L, datasets:[{label:'Mín (ΔNPV)',data:lo},{label:'Máx (ΔNPV)',data:hi}]},
    options:{indexAxis:'y', plugins:{legend:{position:'bottom'}}, scales:{x:{title:{display:true,text:'ΔNPV = NPV_main − NPV_alt (CLP)'}}}}
  });
}
function simulatePair(inp, tweak){
  const list = state.vehicles.length>=2 ? state.vehicles.slice(0,2).map(v=>({type:v.type, mod:findModel(v.type,v.modelKey)}))
                                        : [{type:'EV',mod:{custom:true}}, {type:'ICE',mod:{custom:true}}];
  const res = list.map(x=> computeSingle(inp, x.type, x.mod, tweak));
  res.sort((a,b)=> a.npv-b.npv);
  return {main:res[0], alt:res[1]};
}
function computeSingle(inp,type,mod,tweak){
  const p = {...inp, ...(tweak||{})};
  let precio,residual_pct,energia_fn,mant,seguro,patentes,add_costs;
  if(type==='EV'){
    precio = mod.custom? p.precio_ev : (mod.price ?? p.precio_ev);
    residual_pct = mod.custom? p.res_ev : (mod.residual ?? p.res_ev);
    const kwh100 = mod.custom? p.kwh100 : (mod.kwh100 ?? p.kwh100);
    energia_fn = ()=> energiaEV(p.km,kwh100,p.tarifa_mode,p.p_kwh_home,p.p_kwh_valle,p.p_kwh_punta,p.share_valle,p.p_kwh_pub,p.mix_home);
    mant=p.mant_ev; seguro=p.seg_ev; patentes=p.pat_ev; add_costs=buildAddCosts(p,'EV');
    return npvOption({H:p.H,r:p.r,km:p.km,precio,incentivo:p.inc_ev,mant,seguro,patentes,energia_fn,residual_pct,add_costs,type:'EV'});
  }else{
    precio = mod.custom? p.precio_ice : (mod.price ?? p.precio_ice);
    residual_pct = mod.custom? p.res_ice : (mod.residual ?? p.res_ice);
    const l100 = mod.custom? p.l100 : (mod.l100 ?? p.l100);
    energia_fn = ()=> energiaICE(p.km,l100,p.p_fuel);
    mant=p.mant_ice; seguro=p.seg_ice; patentes=p.pat_ice; add_costs=buildAddCosts(p,'ICE');
    return npvOption({H:p.H,r:p.r,km:p.km,precio,incentivo:0,mant,seguro,patentes,energia_fn,residual_pct,add_costs,type:'ICE'});
  }
}

/* Tablas VP/Nominal */
function renderTables(results){
  const H = +$('H').value;
  const nominal = $('toggleNominal').checked;
  const host=$('tables'); host.innerHTML='';
  results.forEach((rsl)=>{
    const by = nominal ? rsl.out.byCatNom : rsl.out.byCatVP;
    const years = Array.from({length:H}, (_,i)=> i+1);
    const rows = years.map((y,i)=>{
      const energy = by.energy[i];
      const mant   = by.mant[i];
      const segs   = by.segs[i];
      const events = by.events[i];
      const depr   = by.depr[i];
      const total  = energy+mant+segs+events+depr;
      return {y, energy, mant, segs, events, depr, total};
    });
    const sum = (k)=> rows.reduce((a,x)=>a+x[k],0);
    const tbl = document.createElement('div'); tbl.style.margin='10px 0 18px';
    tbl.innerHTML = `<h3 style="margin:6px 0">${rsl.label} ${nominal? '(Nominal)' : '(Valor Presente)'}</h3>
      <table class="table">
        <thead>
          <tr>
            <th>Rubro \\ Año</th>
            ${years.map(y=>`<th>${y}</th>`).join('')}
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Energía</td>${rows.map(x=>`<td>${fmtN(x.energy)}</td>`).join('')}<td>${fmtN(sum('energy'))}</td></tr>
          <tr><td>Mantención</td>${rows.map(x=>`<td>${fmtN(x.mant)}</td>`).join('')}<td>${fmtN(sum('mant'))}</td></tr>
          <tr><td>Seguros/Permisos</td>${rows.map(x=>`<td>${fmtN(x.segs)}</td>`).join('')}<td>${fmtN(sum('segs'))}</td></tr>
          <tr><td>Eventos</td>${rows.map(x=>`<td>${fmtN(x.events)}</td>`).join('')}<td>${fmtN(sum('events'))}</td></tr>
          <tr><td>Depreciación/Residual</td>${rows.map(x=>`<td>${fmtN(x.depr)}</td>`).join('')}<td>${fmtN(sum('depr'))}</td></tr>
        </tbody>
        <tfoot>
          ${ nominal
            ? `<tr><td><b>Total nominal (sin Capex)</b></td>${years.map(_=>`<td></td>`).join('')}<td><b>${fmtN(sum('total'))}</b></td></tr>
               <tr><td><b>Capex inicial − Incentivo</b></td>${years.map(_=>`<td></td>`).join('')}<td><b>${fmtN(rsl.out.capex0)}</b></td></tr>
               <tr><td><b>Total nominal + Capex</b></td>${years.map(_=>`<td></td>`).join('')}<td><b>${fmtN(sum('total')+rsl.out.capex0)}</b></td></tr>
               <tr><td><b>CLP/km (de EAC)</b></td>${years.map(_=>`<td></td>`).join('')}<td><b>${fmt2(rsl.out.lco)}</b></td></tr>`
            : `<tr><td><b>NPV (sin Capex)</b></td>${years.map(_=>`<td></td>`).join('')}<td><b>${fmtN(sum('total'))}</b></td></tr>
               <tr><td><b>Capex inicial − Incentivo</b></td>${years.map(_=>`<td></td>`).join('')}<td><b>${fmtN(rsl.out.capex0)}</b></td></tr>
               <tr><td><b>NPV total</b></td>${years.map(_=>`<td></td>`).join('')}<td><b>${fmtN(rsl.out.npv)}</b></td></tr>
               <tr><td><b>CLP/km</b></td>${years.map(_=>`<td></td>`).join('')}<td><b>${fmt2(rsl.out.lco)}</b></td></tr>`
          }
        </tfoot>
      </table>`;
    host.appendChild(tbl);
  });
}

/* Share, ayuda, cómo calculamos */
$('shareUrl').addEventListener('click', ()=>{
  const inp=makeInputs();
  const params=new URLSearchParams();
  Object.entries(inp).forEach(([k,v])=> params.set(k,String(v)));
  params.set('veh', state.vehicles.map(v=>`${v.type}:${v.modelKey}`).join('|'));
  const url=`${location.origin}${location.pathname}?${params.toString()}`;
  navigator.clipboard.writeText(url).then(()=> alert('Link copiado al portapapeles.'));
});
$('help').onclick=()=> $('modalHelp').classList.add('show');
$('openHow').onclick=(e)=>{ e.preventDefault(); $('modalHow').classList.add('show'); };
document.querySelectorAll('.closex').forEach(x=> x.onclick=()=> $(x.getAttribute('data-x')).classList.remove('show'));
document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show')); }});

/* Botón Calcular en header */
$('calcHeader').addEventListener('click', calc);
/* Toggle VP/Nominal repinta tablas con últimos resultados */
$('toggleNominal').addEventListener('change', ()=> { if(lastResults.length) renderTables(lastResults); });

/* Añadir vehículos */
$('addEV').onclick=()=> addVehicle('EV');
$('addICE').onclick=()=> addVehicle('ICE');

/* Init */
(function init(){
  Object.entries(defaults).forEach(([k,v])=>{ if($(k)){ if(typeof v==='boolean') $(k).checked=v; else $(k).value=v; }});
  for(const [k,v] of qs.entries()){
    if(k==='veh') continue;
    if($(k)) { if($(k).type==='checkbox') $(k).checked=(v==='true'||v==='1'); else $(k).value=(/^\d+(\.\d+)?$/.test(v)? Number(v): v); }
  }
  syncLabels();
  if(qs.get('veh')){
    const spec = qs.get('veh').split('|').slice(0,4);
    spec.forEach(s=>{
      const [type,modelKey]=s.split(':');
      if(type==='EV'||type==='ICE') addVehicle(type, modelKey);
    });
  }else{
    addVehicle('EV','byd_dolphin_mini');
    addVehicle('ICE','suzuki_swift');
  }
  // Si quieres cálculo automático al cargar, descomenta:
  // calc();
})();
</script>
</body>
</html>
